<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ユメミる草原 - ラジオ体操参加</title>

  <style>
    :root {
      --bg: #f6f8fa;
      --card: #ffffff;
      --accent: #334155;
      --yume-pink: #f7d9ec;
      --yume-blue: #3d9aff;
      --yume-white: #ffffff;
      --bar-bg: #7af0ff;
      --bar-fill: #ffffff;
    }
    html, body { height:100%; margin:0; overflow:hidden; font-family:system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif; background-color:#d2e879; background:url('https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/home.png') center/cover no-repeat; color:var(--accent);}
    .page { display:none; width:100vw; height:100vh; }
    .page.active { display:flex; align-items:center; justify-content:center; }
    .card-wrapper { transform-origin: top center; display:flex; align-items:center; justify-content:center; width:100%; height:100%; overflow:hidden; }
    .card { background: rgba(255,255,255,0.05); backdrop-filter: blur(3px); padding:28px; border-radius:18px; box-shadow:0 6px 20px rgba(16,24,40,0.30); width:100%; max-width:720px; text-align:center; border:3px solid var(--yume-blue); box-sizing:border-box; }
    h1 { font-weight:700; margin:0 0 10px; font-size:38px; letter-spacing:0.02em; color:#67b337; text-shadow:0 0 6px #ffffffaa; }
    p.subtitle { margin:0 0 12px; color:#475569; font-weight:600; }
    p.desc { margin:0 0 20px; color:#334155; }
    .button-row { display:flex; justify-content:center; align-items:center; margin-bottom:1px; gap:3px; }
    .button-row img { width:130px; height:200px; object-fit:contain; cursor:pointer; flex:none; }
    .button-row img:nth-child(2) { width:200px; }
    #remainingTime { font-size:17px; font-weight:700; margin-bottom:4px; color:#ffffff; text-shadow:0 0 4px #0008; }
    .time-bar-wrap { width:100%; height:16px; background:var(--bar-bg); border-radius:20px; margin-top:6px; margin-bottom:14px; overflow:hidden; border:2px solid #fff; position:relative; }
    .time-bar { height:100%; width:100%; background:var(--bar-fill); position:absolute; right:0; top:0; transition: width 0.5s linear; }
    .fullimage { width:100%; height:100%; object-fit:contain; background:white; }
    .home-btn { position:absolute; bottom:20px; right:20px; padding:12px 20px; background:#f7d9ec; color:#333; border-radius:12px; font-size:18px; font-weight:700; box-shadow:0 3px 6px #0005; }
    #playerContainer { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:#000000; z-index:9999; flex-direction:column; padding:20px; box-sizing:border-box; }
    video { width:100%; height:100%; object-fit:contain; background:#ccc84b; }
    #yumekoDisplay, #yumekoDisplay2 { position:relative; margin-top:12px; color:#333; }
    #yumekoDisplay img, #yumekoDisplay2 img { max-width:160px; border-radius:10px; display:block; margin:0 auto 8px; }
    #endScreen { display:none; width:100%; height:100%; background:#334155; color:#fff; font-size:36px; font-weight:bold; align-items:center; justify-content:center; text-align:center; flex-direction:column; }
    .small-note { font-size:14px; color:#475569; margin-top:8px; font-weight:600; }
    input[type="file"] { display:none; }

    /* 新UI：保存領域 */
    .card-preview { display:flex; gap:12px; align-items:flex-start; color:#fff; }
    .left-area { display:flex; flex-direction:column; gap:8px; align-items:center; }
    .preview-img { max-width:220px; border-radius:8px; box-shadow:0 2px 8px #0008; background:#fff; }
    .qr-thumb { width:120px; height:120px; background:#fff; display:block; }
    .right-area { background:#000; color:#fff; padding:12px; border-radius:8px; min-width:260px; max-width:360px; box-sizing:border-box; }
    .status-line { margin:6px 0; font-weight:700; }
    .name-input-row { display:flex; gap:8px; margin-top:8px; align-items:center; }
    .name-input-row input[type="text"] { flex:1; padding:8px 10px; border-radius:8px; border:1px solid #444; background:rgba(255,255,255,0.02); color:#fff; }
    .name-input-row input::placeholder { color:#ddd; }
    .save-btn { padding:8px 12px; border-radius:8px; background:#3d9aff; color:#fff; border:none; font-weight:800; cursor:pointer; }
    .small-muted { font-size:12px; color:#bbb; margin-top:6px; }
    .hidden { display:none !important; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
</head>

<body>

  <!-- HOME -->
  <div id="home" class="page active">
    <div class="card-wrapper">
      <div class="card">
        <h1>ユメミる草原</h1>
        <div class="button-row">
          <img src="https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/zukan.png" alt="図鑑" onclick="showPage('zukan')">
          <img src="https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/radio.png" id="joinBtnImg" alt="ラジオ体操参加">
          <img src="https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/howto.png" alt="遊び方" onclick="showPage('howto')">
        </div>
        <p class="subtitle">出撃可能時間 : （Local Time) <strong>06:00〜06:03</strong></p>
        <p class="desc">ーーーー今後、ステータス200より上の子と遊べるようになりますーーーー</p>
        <div id="remainingTime"></div>
        <div class="time-bar-wrap">
          <div id="timeBar" class="time-bar"></div>
        </div>

        <!-- マイユメっ子ボタン -->
        <button id="myYumekoNavBtn" class="home-btn" style="position:relative; bottom:0; right:auto; margin-bottom:12px; display:inline-block; background:#3d9aff; color:#fff;">
          マイユメっ子
        </button>

        <br>
        <input id="pw" type="password" placeholder="運営用パスワード " style="margin-top:12px; padding:8px 10px; border-radius:8px; border:1px solid #ddd;">
        <button id="myYumekoBtn" class="home-btn" style="display:none;"> ユメっ</button>

        <input type="file" id="uploadImage" accept="image/*">
        <div id="yumekoDisplay"></div>
      </div>
    </div>
  </div>

  <!-- ZUKAN -->
  <div id="zukan" class="page">
    <img src="https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/zu.png" class="fullimage">
    <button class="home-btn" onclick="showPage('home')">ホーム</button>
  </div>

  <!-- HOWTO -->
  <div id="howto" class="page">
    <img src="https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/asobi.png" class="fullimage">
    <button class="home-btn" onclick="showPage('home')">ホーム</button>
  </div>

  <!-- MY YUMEKO -->
  <div id="myyumeko" class="page">
    <div class="card-wrapper">
      <div class="card">
        <h1>マイユメっ子</h1>
        <p class="small-note">保存したユメっ子の画像をそのまま読み込めます</p>
        <button id="myYumekoBtn2" class="home-btn" style="position:static; margin-top:18px; background:#f7d9ec; color:#333; box-shadow:none;">ユメっ子ステータス</button>
        <input type="file" id="uploadImage2" accept="image/*">
        <div id="yumekoDisplay2"></div>
        <button class="home-btn" onclick="showPage('home')" style="background:#fff; color:#333; margin-top:16px;">ホームに戻る</button>
      </div>
    </div>
  </div>

  <div id="playerContainer"></div>

  <div id="endScreen" class="page">
    <div>END</div>
    <button class="home-btn" onclick="showPage('home')">ホームに戻る</button>
  </div>

  <script>
  /* =========================
     共通関数・カードフィット
  ========================= */
  function fitCard() {
    const wrap = document.querySelector('.card-wrapper');
    const card = document.querySelector('.card');
    const wh = window.innerHeight;
    const ch = card.offsetHeight;
    const scale = Math.min(1, wh / (ch + 20));
    wrap.style.transform = `scale(${scale})`;
  }
  window.addEventListener('resize', fitCard);
  window.addEventListener('load', fitCard);

  function showPage(id) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.add('active');
    setTimeout(fitCard, 50);
  }

  /* =========================
     時間管理
  ========================= */
  const config = {
    videos: [
      { id:'v1', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/1o.mp4', weight:18 },
      { id:'v2', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/1x.mp4', weight:2 },
      { id:'v3', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/2o.mp4', weight:17 },
      { id:'v4', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/2x.mp4', weight:1 },
      { id:'v5', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/3o.mp4', weight:17 },
      { id:'v6', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/3x.mp4', weight:1 },
      { id:'v7', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/4o.mp4', weight:9 },
      { id:'v8', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/4x.mp4', weight:1 },
      { id:'v9', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/5o.mp4', weight:9 },
      { id:'v10', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/5x.mp4', weight:1 },
      { id:'v11', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/6o.mp4', weight:9 },
      { id:'v12', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/6x.mp4', weight:1 },
      { id:'v13', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/7o.mp4', weight:9 },
      { id:'v14', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/7x.mp4', weight:1 },
      { id:'v15', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/8x.mp4', weight:2 },
      { id:'v16', url:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/9x.mp4', weight:2 }
    ],
    bypassPassword:'1122',
    allowedTimes:[{hour:6, startMinute:0, endMinute:3}]
  };

  function nowJST() {
    const d = new Date();
    return new Date(d.getTime() + d.getTimezoneOffset() * 60000 + 9*3600*1000);
  }

  function isWithinAllowedWindow() {
    const j = nowJST();
    for (const t of config.allowedTimes) {
      const s = new Date(j); s.setHours(t.hour, t.startMinute,0,0);
      const e = new Date(j); e.setHours(t.hour, t.endMinute,59,999);
      if (j>=s && j<=e) return true;
    }
    return false;
  }

  function getNextStart() {
    const j = nowJST();
    let next = null;
    for(const t of config.allowedTimes){
      const s = new Date(j); s.setHours(t.hour, t.startMinute,0,0);
      if(s>j && (!next||s<next)) next=s;
    }
    if(!next){
      const t = config.allowedTimes[0];
      next = new Date(j.getTime()+24*3600*1000);
      next.setHours(t.hour,t.startMinute,0,0);
    }
    return next;
  }

  /* =========================
     タイムバー更新
  ========================= */
  function updateRemaining(){
    const j=nowJST();
    const pw=document.getElementById('pw').value===config.bypassPassword;
    const joinBtnImg=document.getElementById('joinBtnImg');
    const tDiv=document.getElementById('remainingTime');
    const bar=document.getElementById('timeBar');
    const allowed=isWithinAllowedWindow()||pw;
    joinBtnImg.style.opacity=allowed?1:0.45;
    joinBtnImg.style.pointerEvents=allowed?'auto':'none';
    if(pw){ tDiv.textContent='運営モード - いつでも開始できます'; bar.style.width='0%'; return; }
    const next=getNextStart();
    const startToday=new Date(j); startToday.setHours(6,0,0,0);
    if(j<startToday) startToday.setDate(startToday.getDate()-1);
    const totalDaySec=24*3600;
    const elapsedSec=(j-startToday)/1000;
    const percentDay=elapsedSec/totalDaySec*100;
    const invPercentDay=100-percentDay;
    if(isWithinAllowedWindow()){
      const t=config.allowedTimes[0];
      const start=new Date(j); start.setHours(t.hour,t.startMinute,0,0);
      const end=new Date(j); end.setHours(t.hour,t.endMinute,59,999);
      const diff=(end-j)/1000;
      const min=Math.floor(diff/60);
      const sec=Math.floor(diff%60);
      tDiv.textContent=`開始可能時間内 : 残り ${min}分 ${sec}秒`;
      const totalSecWindow=(end-start)/1000;
      const elapsedWindow=(j-start)/1000;
      const percentWindow=elapsedWindow/totalSecWindow*100;
      bar.style.width=`${100-percentWindow}%`;
    } else {
      const diff=(next-j)/1000;
      const h=Math.floor(diff/3600);
      const m=Math.floor((diff%3600)/60);
      const s=Math.floor(diff%60);
      tDiv.textContent=`残り : ${h}時間 ${m}分 ${s}秒`;
      bar.style.width=`${invPercentDay}%`;
    }
  }

  setInterval(updateRemaining,1000);
  updateRemaining();

  /* =========================
     複数タブ制御＋リロード防止
  ========================= */
  const TAB_KEY='myYumekoTabLock';
  const TIMEOUT_MIN=5;
  function checkTabLock(){
    const j=nowJST();
    if(!isWithinAllowedWindow()) return; // 制御時間外は無効
    const lock=localStorage.getItem(TAB_KEY);
    if(lock){
      const data=JSON.parse(lock);
      const expire=new Date(data.time);
      if(j<expire){
        alert('このサイトは他のタブで開かれています。5分後に解除されます');
        document.body.innerHTML='<h1 style="text-align:center;margin-top:40vh;color:red;">別タブで利用中です</h1>';
        throw new Error('Tab locked');
      }
    }
    const expire=new Date(j.getTime()+TIMEOUT_MIN*60*1000);
    localStorage.setItem(TAB_KEY,JSON.stringify({time:expire.toISOString()}));
  }
  window.addEventListener('load',checkTabLock);
  window.addEventListener('beforeunload',()=>{ localStorage.removeItem(TAB_KEY); });

  /* =========================
     動画選択
  ========================= */
  function pickVideo(videos){
    const total=videos.reduce((s,v)=>s+v.weight,0);
    let r=Math.random()*total;
    for(const v of videos){ r-=v.weight; if(r<0) return v; }
    return videos[videos.length-1];
  }

  const characterMap={
    v1:{img:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char1.jpg', id:'CHARA001'},
    v3:{img:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char2.jpg', id:'CHARA002'},
    v5:{img:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char3.jpg', id:'CHARA003'},
    v7:{img:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char4.jpg', id:'CHARA004'},
    v9:{img:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char5.jpg', id:'CHARA005'},
    v11:{img:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char6.jpg', id:'CHARA006'},
    v13:{img:'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char7.jpg', id:'CHARA007'}
  };

  function generateStatus(){
    function rnd(){
      const r=Math.random()*100;
      if(r<0.1) return 100;
      if(r<5) return Math.floor(90+Math.random()*9);
      if(r<10) return Math.floor(80+Math.random()*10);
      if(r<20) return Math.floor(70+Math.random()*10);
      return Math.floor(Math.random()*70);
    }
    return { azatosa:rnd(), health:rnd(), sweetness:rnd() };
  }

  /**
   *  generateCharacterCard
   *  - 既存の合成を壊さず、詰めて小さく画像を配置
   *  - 右側にステータス（白文字）を表示
   *  - 名前を入力する欄（placeholder: ユメっ子に名前を付ける）と保存ボタンを配置
   *  - 保存時は入力名をファイル名にして1枚のPNGを生成してダウンロード
   */
  function generateCharacterCard(charInfo,status){
    const container=document.getElementById('playerContainer');
    container.innerHTML='';

    // プレビュー領域作成
    const previewWrap=document.createElement('div');
    previewWrap.className='card-preview';

    const leftArea=document.createElement('div');
    leftArea.className='left-area';

    const previewImg=document.createElement('img');
    previewImg.className='preview-img';
    previewImg.crossOrigin='anonymous';
    previewImg.src=charInfo.img;

    const qrThumb=document.createElement('canvas');
    qrThumb.className='qr-thumb';

    leftArea.appendChild(previewImg);
    leftArea.appendChild(qrThumb);

    const rightArea=document.createElement('div');
    rightArea.className='right-area';

    // ステータス表示
    const idLine=document.createElement('div');
    idLine.className='status-line';
    idLine.textContent = `ID: ${charInfo.id}`;

    const azLine=document.createElement('div');
    azLine.className='status-line';
    azLine.textContent = `あざとさ: ${status.azatosa}`;

    const hpLine=document.createElement('div');
    hpLine.className='status-line';
    hpLine.textContent = `体力: ${status.health}`;

    const swLine=document.createElement('div');
    swLine.className='status-line';
    swLine.textContent = `かわいさ: ${status.sweetness}`;

    rightArea.appendChild(idLine);
    rightArea.appendChild(azLine);
    rightArea.appendChild(hpLine);
    rightArea.appendChild(swLine);

    // 名前入力欄と保存ボタン
    const nameRow=document.createElement('div');
    nameRow.className='name-input-row';

    const nameInput=document.createElement('input');
    nameInput.type='text';
    nameInput.placeholder='ユメっ子に名前を付ける';
    nameInput.value = ''; // 初期は空。必要ならここに既定値を入れる

    const saveBtn=document.createElement('button');
    saveBtn.className='save-btn';
    saveBtn.textContent='保存';

    nameRow.appendChild(nameInput);
    nameRow.appendChild(saveBtn);

    rightArea.appendChild(nameRow);
    rightArea.appendChild(document.createElement('div')).className='small-muted';
    const note=document.createElement('div');
    note.className='small-muted';
    note.textContent='保存すると入力した名前で1枚の画像がダウンロードされます';
    rightArea.appendChild(note);

    previewWrap.appendChild(leftArea);
    previewWrap.appendChild(rightArea);

    // 追加UIをcontainerに表示
    container.appendChild(previewWrap);

    // 表示調整
    container.style.display='flex';
    container.style.justifyContent='center';
    container.style.alignItems='center';
    container.style.flexDirection='column';

    // QRコードを生成してqrThumbキャンバスに描画
    const qrData = JSON.stringify({id:charInfo.id, img:charInfo.img, ...status});
    QRCode.toCanvas(qrThumb, qrData, { width: 300 }, (err) => {
      if(err) console.error('QR作成エラー', err);
    });

    // 保存処理（名前を使って画像を合成してダウンロード）
    saveBtn.addEventListener('click', async ()=> {
      const nameText = (nameInput.value || '').trim() || charInfo.id;
      // 画像とQRを使って最終キャンバス作成
      try {
        const charImgEl = new Image();
        charImgEl.crossOrigin='anonymous';
        charImgEl.src = charInfo.img;
        await new Promise((res, rej) => {
          charImgEl.onload = res;
          charImgEl.onerror = rej;
        });

        // QRは既にqrThumbキャンバスに描かれている -> これを画像化
        const qrImgEl = new Image();
        qrImgEl.src = qrThumb.toDataURL('image/png');
        await new Promise((res, rej) => {
          qrImgEl.onload = res;
          qrImgEl.onerror = rej;
        });

        // レイアウト計算（詰めて小さく）
        const padding = 16;
        const scale = 0.8; // 画像縮小率（詰める）
        const charW = Math.round(charImgEl.width * scale);
        const charH = Math.round(charImgEl.height * scale);

        const qrSize = Math.round(Math.min(300, qrImgEl.width * 1.0, charW * 0.7));


        const textAreaWidth = 360;
        const textAreaPadding = 12;

        // 横幅：左側の最大(キャラ幅 or qr幅) + padding + テキスト領域
        const leftColWidth = Math.max(charW, qrSize);
        const canvasWidth = leftColWidth + padding + textAreaWidth + padding*1;
        // 高さ：キャラ高さ + qrを下に並べた場合の高さ or テキスト領域の高さ
        const leftColHeight = charH + padding + qrSize;
        const textAreaHeight = 220;
        const canvasHeight = Math.max(leftColHeight, textAreaHeight) + padding*1;

        // キャンバス作成
        const canvas = document.createElement('canvas');
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        const ctx = canvas.getContext('2d');

        // 背景：黒系（右側は黒、左側少し明るめに）
        ctx.fillStyle = '#0b0b0b';
        ctx.fillRect(0,0,canvas.width,canvas.height);

        // 左列背景（少し暗めの枠）
        ctx.fillStyle = '#0f0f0f';
        ctx.fillRect(padding/2, padding/2, leftColWidth + padding/2, canvas.height - padding);

        // キャラ画像描画（左上、詰めて表示）
        const charX = padding;
        const charY = padding;
        ctx.drawImage(charImgEl, charX, charY, charW, charH);

        // QR描画（キャラの下、左寄せ）
        const qrX = padding;
        const qrY = charY + charH + 8;
        ctx.fillStyle = '#fff';
        // 背景白の小枠を作ってからQRを描画（見栄え）
        ctx.fillRect(qrX-6, qrY-6, qrSize+12, qrSize+12);
        ctx.drawImage(qrImgEl, qrX, qrY, qrSize, qrSize);

        // 右側：ステータステキスト（白）
        const textX = leftColWidth + padding + textAreaPadding;
        let currentY = padding + 28;
        ctx.fillStyle = '#fff';
        // 名前（大きめ）
        ctx.font = '26px sans-serif';
        ctx.fillText(nameText, textX, currentY);
        currentY += 36;

        // ID
        ctx.font = '18px sans-serif';
        ctx.fillStyle = '#ddd';
        ctx.fillText(`ID: ${charInfo.id}`, textX, currentY);
        currentY += 28;

        // ステータス
        ctx.fillStyle = '#fff';
        ctx.font = '20px sans-serif';
        ctx.fillText(`あざとさ: ${status.azatosa}`, textX, currentY);
        currentY += 28;
        ctx.fillText(`体力: ${status.health}`, textX, currentY);
        currentY += 28;
        ctx.fillText(`かわいさ: ${status.sweetness}`, textX, currentY);
        currentY += 34;

        // 小さな注記
        ctx.font = '14px sans-serif';
        ctx.fillStyle = '#bbb';
        ctx.fillText('ユメミる草原 ', textX, currentY);

        // ダウンロード
        canvas.toBlob((blob) => {
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          // ファイル名は入力名（拡張子付け）
          const safeName = nameText.replace(/[\\\/:*?"<>|]/g, '_') || charInfo.id;
          a.download = `${safeName}.png`;
          a.click();
          URL.revokeObjectURL(a.href);
        }, 'image/png');

      } catch (err) {
        console.error('保存処理でエラー', err);
        alert('画像の保存に失敗しました');
      }
    });

    // クリックでプレビューの画像を拡大して閉じるなどの動作を追加しても良い
  }

  document.getElementById('joinBtnImg').addEventListener('click',onJoin);

  function onJoin(){
    if(!isWithinAllowedWindow() && document.getElementById('pw').value!==config.bypassPassword){
      alert('参加時間外です');
      return;
    }
    const pick=pickVideo(config.videos);
    const container=document.getElementById('playerContainer');
    container.style.display='flex';
    container.innerHTML='';
    const vid=document.createElement('video');
    vid.src=pick.url;
    vid.playsInline=true;
    vid.autoplay=true;
    vid.controls=false;
    container.appendChild(vid);
    vid.addEventListener('loadeddata',async()=>{
      try{ await vid.play(); }catch(e){}
      try{ if(container.requestFullscreen) await container.requestFullscreen({navigationUI:'hide'});}catch(e){}
    });
    vid.addEventListener('ended',async()=>{
      try{ if(document.fullscreenElement) await document.exitFullscreen(); }catch(e){}
      container.innerHTML='';
      const charInfo=characterMap[pick.id];
      if(charInfo){
        const status=generateStatus();
        generateCharacterCard(charInfo,status);
      } else {
        showPage('endScreen');
      }
    });
  }

  async function processUploadedFile(file,displayElementId){
    if(!file) return;
    const img=new Image();
    img.src=URL.createObjectURL(file);
    img.onload=()=>{
      try{
        const canvas=document.createElement('canvas');
        const ctx=canvas.getContext('2d');
        canvas.width=img.width;
        canvas.height=img.height;
        ctx.drawImage(img,0,0);
        const imageData=ctx.getImageData(0,0,canvas.width,canvas.height);
        const code=jsQR(imageData.data,canvas.width,canvas.height);
        if(!code){ alert("QRコードが見つかりません"); return; }
        const data=JSON.parse(code.data);
        const d=document.getElementById(displayElementId);
        d.innerHTML=`
          <img src="${data.img}" alt="ユメっ子画像">
          <div>ID: ${data.id}</div>
          <div>あざとさ: ${data.azatosa}</div>
          <div>体力: ${data.health}</div>
          <div>かわいさ: ${data.sweetness}</div>
        `;
      }catch(err){ console.error(err); alert("QR解析でエラーが発生しました"); }
    };
    img.onerror=()=>{ alert("画像を読み込めませんでした"); };
  }

  document.getElementById('myYumekoBtn').addEventListener('click',()=>{ document.getElementById('uploadImage').click(); });
  document.getElementById('uploadImage').addEventListener('change',async(e)=>{
    const file=e.target.files[0];
    if(!file) return;
    await processUploadedFile(file,'yumekoDisplay');
    e.target.value='';
  });

  document.getElementById('myYumekoNavBtn').addEventListener('click',()=>{ showPage('myyumeko'); });
  document.getElementById('myYumekoBtn2').addEventListener('click',()=>{ document.getElementById('uploadImage2').click(); });
  document.getElementById('uploadImage2').addEventListener('change',async(e)=>{
    const file=e.target.files[0];
    if(!file) return;
    await processUploadedFile(file,'yumekoDisplay2');
    e.target.value='';
  });

  </script>
</body>
</html>







