<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ユメミる草原 - ラジオ体操参加</title>

  <style>
    :root {
      --bg: #f6f8fa;
      --card: #ffffff;
      --accent: #334155;
      --yume-pink: #f7d9ec;
      --yume-blue: #3d9aff;
      --yume-white: #ffffff;
      --bar-bg: #7af0ff;
      --bar-fill: #ffffff;
    }

    html, body {
      height: 100%;
      margin: 0;
      overflow: hidden;
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background-color: #d2e879;
      background: url('https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/home.png') center/cover no-repeat;
      color: var(--accent);
    }

    .page {
      display: none;
      width: 100vw;
      height: 100vh;
    }

    .page.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .card-wrapper {
      transform-origin: top center;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .card {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(3px);
      padding: 28px;
      border-radius: 18px;
      box-shadow: 0 6px 20px rgba(16,24,40,0.30);
      width: 100%;
      max-width: 720px;
      text-align: center;
      border: 3px solid var(--yume-blue);
      box-sizing: border-box;
      position: relative;
    }

    h1 {
      font-weight: 700;
      margin: 0 0 10px;
      font-size: 38px;
      letter-spacing: 0.02em;
      color: #67b337;
      text-shadow: 0 0 6px #ffffffaa;
    }

    p.subtitle {
      margin: 0 0 12px;
      color: #475569;
      font-weight: 600;
    }

    p.desc {
      margin: 0 0 20px;
      color: #334155;
    }

    .button-row {
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 1px;
      gap: 3px;
    }

    .button-row img {
      width: 130px;
      height: 200px;
      object-fit: contain;
      cursor: pointer;
      flex: none;
    }

    .button-row img:nth-child(2) {
      width: 200px;
    }

    #remainingTime {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 6px;
      color: #ffffff;
      text-shadow: 0 0 4px #0008;
    }

    .time-bar-wrap {
      width: 100%;
      height: 16px;
      background: var(--bar-bg);
      border-radius: 20px;
      margin-top: 6px;
      margin-bottom: 14px;
      overflow: hidden;
      border: 2px solid #fff;
      position: relative;
    }

    .time-bar {
      height: 100%;
      width: 100%;
      background: var(--bar-fill);
      position: absolute;
      right: 0;
      top: 0;
      transition: width 0.5s linear;
    }

    .fullimage {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: white;
    }

    .home-btn {
      position: absolute;
      bottom: 20px;
      right: 20px;
      padding: 12px 20px;
      background: #f7d9ec;
      color: #333;
      border-radius: 12px;
      font-size: 18px;
      font-weight: 700;
      box-shadow: 0 3px 6px #0005;
      cursor: pointer;
      border: none;
    }

    #playerContainer {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: #000000;
      z-index: 9999;
      flex-direction: column;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: #ccc84b;
    }

    #yumekoDisplay {
      position: absolute;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      color: #fff;
      z-index: 10000;
    }

    #yumekoDisplay img {
      max-width: 200px;
      display: block;
      margin: 0 auto 10px;
    }

    #endScreen {
      display: none;
      width: 100%;
      height: 100%;
      background: #334155;
      color: #fff;
      font-size: 36px;
      font-weight: bold;
      align-items: center;
      justify-content: center;
      text-align: center;
      flex-direction: column;
    }

    /* マイユメっ子エリア */
    .my-yumeko-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      justify-content: center;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .my-yumeko {
      width: 170px;
      height: 120px;
      border-radius: 12px;
      background: linear-gradient(180deg,#ffffffaa,#ffffff66);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      border: 2px dashed rgba(0,0,0,0.08);
    }

    .my-yumeko.placeholder {
      filter: saturate(0.7);
    }

    .my-yumeko img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      display: block;
    }

    .my-yumeko .inner-btn {
      position: absolute;
      bottom: 6px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.55);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 6px 10px;
      font-weight: 700;
      font-size: 13px;
      cursor: pointer;
      display: none;
    }

    .my-yumeko.has-image .inner-btn {
      display: block;
    }

    .small-note {
      font-size: 12px;
      color: #fff;
      text-shadow: 0 0 3px #0008;
    }

    /* file input visually hidden but accessible */
    input[type="file"] {
      display: none;
    }

    /* responsive tweak for small screens */
    @media (max-width: 480px) {
      .my-yumeko { width: 140px; height: 100px; }
      .button-row img { width: 90px; height: 140px; }
      .button-row img:nth-child(2) { width: 140px; }
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
  <script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>
</head>

<body>

  <!-- HOME -->
  <div id="home" class="page active">
    <div class="card-wrapper">
      <div class="card">

        <h1>ユメミる草原</h1>

        <div class="button-row">
          <img src="https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/zukan.png" alt="図鑑" onclick="showPage('zukan')">
          <img src="https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/radio.png" id="joinBtnImg" alt="ラジオ体操参加">
          <img src="https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/howto.png" alt="遊び方" onclick="showPage('howto')">
        </div>

        <p class="subtitle">出撃可能時間 : （Local Time) <strong>06:00〜06:03</strong></p>
        <p class="desc">ーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーーー</p>

        <div id="remainingTime"></div>
        <div class="time-bar-wrap">
          <div id="timeBar" class="time-bar"></div>
        </div>

        <!-- ここにマイユメっ子エリアを追加 -->
        <div class="my-yumeko-wrap" aria-hidden="false">
          <label id="myYumekoLabel" class="my-yumeko placeholder" title="ここをクリックしてPNGを選択（またはドラッグ＆ドロップ）">
            <span class="small-note">マイユメっ子</span>
            <button class="inner-btn" id="slotLoadBtn">ユメっ子を読み込む</button>
          </label>
          <div class="small-note" style="align-self:center;">（PNGを貼れるよ）</div>
        </div>

        <input id="myYumekoUpload" type="file" accept="image/png,image/*">
        <input id="pw" type="password" placeholder="運営用パスワード ">
        <button id="myYumekoBtn" class="home-btn" style="bottom:60px;">ユメっ子</button>

        <input type="file" id="uploadImage" style="display:none;">
        <div id="yumekoDisplay"></div>

      </div>
    </div>
  </div>

  <!-- ZUKAN -->
  <div id="zukan" class="page">
    <img src="https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/zu.png" class="fullimage">
    <button class="home-btn" onclick="showPage('home')">ホーム</button>
  </div>

  <!-- HOWTO -->
  <div id="howto" class="page">
    <img src="https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/asobi.png" class="fullimage">
    <button class="home-btn" onclick="showPage('home')">ホーム</button>
  </div>

  <div id="playerContainer"></div>

  <div id="endScreen" class="page">
    <div>END</div>
    <button class="home-btn" onclick="showPage('home')">ホームに戻る</button>
  </div>

  <script>
    /* ====================================
       カード自動フィット
    ==================================== */
    function fitCard() {
      const wrap = document.querySelector('.card-wrapper');
      const card = document.querySelector('.card');
      const wh = window.innerHeight;
      const ch = card.offsetHeight;

      const scale = Math.min(1, wh / (ch + 20));
      wrap.style.transform = `scale(${scale})`;
    }

    window.addEventListener('resize', fitCard);
    window.addEventListener('load', fitCard);

    /* ====================================
       ページ切り替え
    ==================================== */
    function showPage(id) {
      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    /* ====================================
       設定（既存のまま）
    ==================================== */
    const config = {
      videos: [
        { id: 'v1', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/1o.mp4', weight: 16 },
        { id: 'v2', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/1x.mp4', weight: 2 },
        { id: 'v3', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/2o.mp4', weight: 16 },
        { id: 'v4', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/2x.mp4', weight: 1 },
        { id: 'v5', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/3o.mp4', weight: 16 },
        { id: 'v6', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/3x.mp4', weight: 1 },
        { id: 'v7', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/4o.mp4', weight: 10 },
        { id: 'v8', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/4x.mp4', weight: 1 },
        { id: 'v9', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/5o.mp4', weight: 10 },
        { id: 'v10', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/5x.mp4', weight: 1 },
        { id: 'v11', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/6o.mp4', weight: 10 },
        { id: 'v12', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/6x.mp4', weight: 1 },
        { id: 'v13', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/7o.mp4', weight: 10 },
        { id: 'v14', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/7x.mp4', weight: 1 },
        { id: 'v15', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/8x.mp4', weight: 2 },
        { id: 'v16', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/9x.mp4', weight: 2 }
      ],
      bypassPassword: '1122',
      allowedTimes: [{ hour: 6, startMinute: 0, endMinute: 3 }]
    };

    /* ====================================
       時間管理（既存のまま）
    ==================================== */
    function nowJST() {
      const d = new Date();
      return new Date(d.getTime() + d.getTimezoneOffset() * 60000 + 9 * 3600 * 1000);
    }

    function isWithinAllowedWindow() {
      const j = nowJST();
      for (const t of config.allowedTimes) {
        const s = new Date(j); s.setHours(t.hour, t.startMinute, 0, 0);
        const e = new Date(j); e.setHours(t.hour, t.endMinute, 59, 999);
        if (j >= s && j <= e) return true;
      }
      return false;
    }

    function getNextStart() {
      const j = nowJST();
      let next = null;

      for (const t of config.allowedTimes) {
        const s = new Date(j);
        s.setHours(t.hour, t.startMinute, 0, 0);
        if (s > j && (!next || s < next)) next = s;
      }

      if (!next) {
        const t = config.allowedTimes[0];
        next = new Date(j.getTime() + 24 * 3600 * 1000);
        next.setHours(t.hour, t.startMinute, 0, 0);
      }
      return next;
    }

    function updateRemaining() {
      const j = nowJST();
      const pw = document.getElementById('pw').value === config.bypassPassword;
      const joinBtnImg = document.getElementById('joinBtnImg');
      const tDiv = document.getElementById('remainingTime');
      const bar = document.getElementById('timeBar');

      const allowed = isWithinAllowedWindow() || pw;

      joinBtnImg.style.opacity = allowed ? 1 : 0.45;
      joinBtnImg.style.pointerEvents = allowed ? 'auto' : 'none';

      if (pw) {
        tDiv.textContent = '運営モード - いつでも開始できます';
        bar.style.width = '0%';
        return;
      }

      const next = getNextStart();
      const startToday = new Date(j);
      startToday.setHours(6, 0, 0, 0);

      if (j < startToday) startToday.setDate(startToday.getDate() - 1);

      const totalDaySec = 24 * 3600;
      const elapsedSec = (j - startToday) / 1000;
      const percentDay = elapsedSec / totalDaySec * 100;
      const invPercentDay = 100 - percentDay;

      if (isWithinAllowedWindow()) {
        const t = config.allowedTimes[0];
        const start = new Date(j);
        start.setHours(t.hour, t.startMinute, 0, 0);

        const end = new Date(j);
        end.setHours(t.hour, t.endMinute, 59, 999);

        const diff = (end - j) / 1000;

        const min = Math.floor(diff / 60);
        const sec = Math.floor(diff % 60);

        tDiv.textContent = `開始可能時間内 : 残り ${min}分 ${sec}秒`;

        const totalSecWindow = (end - start) / 1000;
        const elapsedWindow = (j - start) / 1000;

        const percentWindow = elapsedWindow / totalSecWindow * 100;
        bar.style.width = `${100 - percentWindow}%`;

      } else {
        const diff = (next - j) / 1000;
        const h = Math.floor(diff / 3600);
        const m = Math.floor((diff % 3600) / 60);
        const s = Math.floor(diff % 60);

        tDiv.textContent = `残り : ${h}時間 ${m}分 ${s}秒`;
        bar.style.width = `${invPercentDay}%`;
      }
    }

    setInterval(updateRemaining, 1000);
    updateRemaining();

    /* ====================================
       ランダム動画選択（既存）
    ==================================== */
    document.getElementById('joinBtnImg').addEventListener('click', onJoin);

    function pickVideo(videos) {
      const total = videos.reduce((s, v) => s + v.weight, 0);
      let r = Math.random() * total;

      for (const v of videos) {
        r -= v.weight;
        if (r < 0) return v;
      }

      return videos[videos.length - 1];
    }

    /* ====================================
       キャラマップ（既存）
    ==================================== */
    const characterMap = {
      v1: { img: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char1.jpg', id: 'CHARA001' },
      v3: { img: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char2.jpg', id: 'CHARA002' },
      v5: { img: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char3.jpg', id: 'CHARA003' },
      v7: { img: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char4.jpg', id: 'CHARA004' },
      v9: { img: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char5.jpg', id: 'CHARA005' },
      v11:{ img: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char6.jpg', id: 'CHARA006' },
      v13:{ img: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/char7.jpg', id: 'CHARA007' }
    };

    /* ====================================
       キャラステ生成（既存）
    ==================================== */
    function generateStatus() {
      function rnd() {
        const r = Math.random() * 100;
        if (r < 0.1) return 100;
        if (r < 5) return Math.floor(90 + Math.random() * 9);
        if (r < 10) return Math.floor(80 + Math.random() * 10);
        if (r < 20) return Math.floor(70 + Math.random() * 10);
        return Math.floor(Math.random() * 70);
      }

      return {
        azatosa: rnd(),
        health: rnd(),
        sweetness: rnd()
      };
    }

    /* ====================================
       キャラカード生成（既存）
    ==================================== */
    function generateCharacterCard(charInfo, status) {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      const img = new Image();

      img.crossOrigin = 'anonymous';
      img.src = charInfo.img;

      img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;

        ctx.drawImage(img, 0, 0);

        const qrSize = Math.min(180, canvas.width / 3);

        ctx.fillStyle = 'white';
        ctx.fillRect(10, canvas.height - qrSize - 10, qrSize, qrSize);

        const qrCanvas = document.createElement('canvas');
        const qrData = JSON.stringify({ id: charInfo.id, img: charInfo.img, ...status });

        QRCode.toCanvas(qrCanvas, qrData, { width: qrSize }, () => {
          ctx.drawImage(qrCanvas, 10, canvas.height - qrSize - 10);

          const container = document.getElementById('playerContainer');
          container.innerHTML = '';
          container.style.display = 'flex';

          const resultImg = new Image();
          resultImg.src = canvas.toDataURL('image/png');
          resultImg.style.maxWidth = '80%';
          resultImg.style.maxHeight = '80%';
          container.appendChild(resultImg);

          const link = document.createElement('a');
          link.href = resultImg.src;
          link.download = `${charInfo.id}.png`;
          link.textContent = '画像を保存';
          link.style.display = 'block';
          link.style.color = '#fff';
          link.style.marginTop = '10px';

          container.appendChild(link);
        });
      };
    }

    /* ====================================
       ラジオ体操参加（既存）
    ==================================== */
    function onJoin() {
      const pick = pickVideo(config.videos);
      const container = document.getElementById('playerContainer');

      container.style.display = 'flex';
      container.innerHTML = '';

      const vid = document.createElement('video');
      vid.src = pick.url;
      vid.playsInline = true;
      vid.autoplay = true;
      vid.controls = false;

      container.appendChild(vid);

      vid.addEventListener('loadeddata', async () => {
        try { await vid.play(); } catch(e) {}
        try { if (container.requestFullscreen) await container.requestFullscreen({ navigationUI: 'hide' }); } catch(e) {}
      });

      vid.addEventListener('ended', async () => {
        try { if (document.fullscreenElement) await document.exitFullscreen(); } catch(e) {}

        container.innerHTML = '';

        const charInfo = characterMap[pick.id];

        if (charInfo) {
          const status = generateStatus();
          generateCharacterCard(charInfo, status);
        } else {
          showPage('endScreen');
        }
      });
    }

    /* ====================================
       既存: ユメっ子読み込み（QR解析） - ファイル選択での挙動
    ==================================== */
    document.getElementById('myYumekoBtn').addEventListener('click', () => {
      // 既存の挙動：ユーザーが手動で画像を選ぶ（既存のアップロード input を開く）
      document.getElementById('uploadImage').click();
    });

    document.getElementById('uploadImage').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      try {
        const dataURL = await fileToDataURL(file);
        await parseYumekoFromDataURL(dataURL);
      } catch (err) {
        alert('画像の読み込みに失敗しました');
        console.error(err);
      }
    });

    /* ====================================
       新規: マイユメっ子領域 - PNG貼り付け / ドラッグ＆ドロップ / 登録した画像を解析
    ==================================== */
    const myYumekoLabel = document.getElementById('myYumekoLabel');
    const myYumekoUpload = document.getElementById('myYumekoUpload');
    const slotLoadBtn = document.getElementById('slotLoadBtn');

    // 保持するデータURL（登録されたPNG）
    let myYumekoDataURL = null;

    // クリックでファイル選択
    myYumekoLabel.addEventListener('click', (e) => {
      // クリックでアップロードを開く
      myYumekoUpload.click();
    });

    // ドラッグ＆ドロップ対応
    myYumekoLabel.addEventListener('dragover', (e) => {
      e.preventDefault();
      myYumekoLabel.style.opacity = '0.85';
    });

    myYumekoLabel.addEventListener('dragleave', (e) => {
      e.preventDefault();
      myYumekoLabel.style.opacity = '1';
    });

    myYumekoLabel.addEventListener('drop', (e) => {
      e.preventDefault();
      myYumekoLabel.style.opacity = '1';
      const dt = e.dataTransfer;
      if (!dt) return;
      const f = dt.files && dt.files[0];
      if (!f) return;
      handleMyYumekoFile(f);
    });

    myYumekoUpload.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (!f) return;
      handleMyYumekoFile(f);
      // reset so same file can be chosen again if needed
      myYumekoUpload.value = '';
    });

    async function handleMyYumekoFile(file) {
      // PNG推奨だが image/* を受ける
      if (!file.type.startsWith('image/')) {
        alert('画像ファイルを選択してください (PNG 等)');
        return;
      }
      try {
        const dataURL = await fileToDataURL(file);
        registerMyYumekoDataURL(dataURL);
      } catch (err) {
        console.error(err);
        alert('ファイル読み込みに失敗しました');
      }
    }

    function registerMyYumekoDataURL(dataURL) {
      myYumekoDataURL = dataURL;
      // 表示を差し替え
      myYumekoLabel.classList.remove('placeholder');
      myYumekoLabel.classList.add('has-image');
      myYumekoLabel.innerHTML = ''; // 中身クリア
      const img = document.createElement('img');
      img.src = dataURL;
      img.alt = 'マイユメっ子';
      myYumekoLabel.appendChild(img);

      // inner button は再追加
      const innerBtn = document.createElement('button');
      innerBtn.className = 'inner-btn';
      innerBtn.id = 'slotLoadBtnInner';
      innerBtn.textContent = 'ユメっ子を読み込む';
      innerBtn.addEventListener('click', async (ev) => {
        ev.stopPropagation(); // 親ラベルのクリックでファイル選択が開かないように
        if (!myYumekoDataURL) { alert('まず画像を登録してください'); return; }
        await parseYumekoFromDataURL(myYumekoDataURL);
      });

      myYumekoLabel.appendChild(innerBtn);

      // 右下小さな削除アイコン（任意）
      const delBtn = document.createElement('button');
      delBtn.textContent = '削除';
      delBtn.title = '登録画像を削除';
      delBtn.style.position = 'absolute';
      delBtn.style.top = '6px';
      delBtn.style.right = '6px';
      delBtn.style.background = 'rgba(0,0,0,0.45)';
      delBtn.style.color = '#fff';
      delBtn.style.border = 'none';
      delBtn.style.borderRadius = '6px';
      delBtn.style.padding = '4px 6px';
      delBtn.style.cursor = 'pointer';
      delBtn.addEventListener('click', (ev) => {
        ev.stopPropagation();
        clearMyYumekoSlot();
      });
      myYumekoLabel.appendChild(delBtn);
    }

    function clearMyYumekoSlot() {
      myYumekoDataURL = null;
      myYumekoLabel.classList.remove('has-image');
      myYumekoLabel.classList.add('placeholder');
      myYumekoLabel.innerHTML = '<span class="small-note">マイユメっ子</span><button class="inner-btn" id="slotLoadBtn">ユメっ子を読み込む</button>';
      // 再バインド inner btn (ただし placeholder の時は非表示のまま)
      const b = document.getElementById('slotLoadBtn');
      if (b) b.style.display = 'none';
    }

    // 初期化：placeholder の inner ボタンは非表示にしておく
    (function initSlot() {
      const b = document.getElementById('slotLoadBtn');
      if (b) b.style.display = 'none';
    })();

    /* ====================================
       ユーティリティ: File -> DataURL
    ==================================== */
    function fileToDataURL(file) {
      return new Promise((resolve, reject) => {
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = reject;
        r.readAsDataURL(file);
      });
    }

    /* ====================================
       QR解析: DataURLを使って既存の表示（yumekoDisplay）へ
       （uploadImage の流れと同様の出力）
    ==================================== */
    async function parseYumekoFromDataURL(dataURL) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = dataURL;

        img.onload = () => {
          try {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);

            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, canvas.width, canvas.height);

            if (!code) {
              alert("QRコードが見つかりません");
              return resolve(null);
            }

            let data;
            try {
              data = JSON.parse(code.data);
            } catch (err) {
              alert("QRの内容が不正です");
              return resolve(null);
            }

            const d = document.getElementById('yumekoDisplay');
            d.innerHTML = `
              <img src="${data.img}">
              <div style="color:#fff">ID: ${escapeHtml(String(data.id || ''))}</div>
              <div style="color:#fff">あざとさ: ${escapeHtml(String(data.azatosa || ''))}</div>
              <div style="color:#fff">体力: ${escapeHtml(String(data.health || ''))}</div>
              <div style="color:#fff">かわいさ: ${escapeHtml(String(data.sweetness || ''))}</div>
            `;
            return resolve(data);
          } catch (err) {
            console.error(err);
            alert('画像解析中にエラーが発生しました');
            return resolve(null);
          }
        };

        img.onerror = (e) => {
          console.error('Image load error', e);
          alert('画像を読み込めませんでした');
          return resolve(null);
        };
      });
    }

    // 簡易エスケープ（XSS対策）
    function escapeHtml(s) {
      return s.replace(/[&<>"'`=\/]/g, function (c) {
        return ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;',
          '/': '&#47;',
          '`': '&#96;',
          '=': '&#61;'
        })[c];
      });
    }

    /* ====================================
       （既存）ページ外クリックで playerContainer を閉じる等の補助
    ==================================== */
    document.getElementById('playerContainer').addEventListener('click', (e) => {
      // クリックで閉じる（ただし中の画像やリンクをクリックしたいなら無効化）
      if (e.target === e.currentTarget) {
        e.currentTarget.style.display = 'none';
      }
    });

    // ESC でフルスクを抜ける等の簡易処理
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        try { if (document.fullscreenElement) document.exitFullscreen(); } catch (err) {}
        const container = document.getElementById('playerContainer');
        container.style.display = 'none';
      }
    });

    // ページ読み込み時の初期スロットクリア
    clearMyYumekoSlot();

  </script>

</body>
</html>
