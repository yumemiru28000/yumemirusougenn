<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ユメミる草原 - ラジオ体操参加</title>
<style>
:root{--bg:#f6f8fa;--card:#ffffff;--accent:#334155}
html,body{height:100%;margin:0;font-family:system-ui,-apple-system,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif;background:var(--bg);color:var(--accent)}
.wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:32px}
.card{background:var(--card);padding:28px;border-radius:12px;box-shadow:0 6px 20px rgba(16,24,40,0.06);width:100%;max-width:720px;text-align:center}
h1{font-weight:700;margin:0 0 10px;font-size:36px;letter-spacing:0.02em}
p.subtitle{margin:0 0 18px;color:#475569}
.desc{margin:8px 0 22px;color:#334155}
.controls{display:flex;gap:8px;justify-content:center;align-items:center}
input[type=password]{padding:8px 10px;border-radius:8px;border:1px solid #dde4ee}
button{background:#1f6feb;color:#fff;border:0;padding:12px 18px;border-radius:10px;font-size:16px;cursor:pointer}
button:disabled{opacity:0.45;cursor:not-allowed}
.small{font-size:12px;color:#64748b;margin-top:12px}
#remainingTime{font-size:16px;color:#ff4d4f;margin-bottom:10px}
#playerContainer{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:#000;z-index:9999;color:#fff;font-size:64px;text-align:center;}
video{max-width:100%;max-height:100%;width:100%;height:100%;object-fit:cover}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>ユメミる草原</h1>
    <p class="subtitle">ラジオ体操開始時間: 毎朝6時、その他指定時間にも参加可能</p>
    <p class="desc">以下の「ラジオ体操参加」ボタンは日本時間の <strong>06:00〜06:05</strong> と設定した時間に押せます。パスワードを入れるといつでも参加可能です。</p>
    <div id="remainingTime"></div>
    <div class="controls">
      <input id="pw" type="password" placeholder="パスワード (省略可)" aria-label="password">
      <button id="joinBtn" disabled>ラジオ体操参加</button>
    </div>
    <div class="small">※ボタンを押すと画面が切り替わり、動画が全画面で自動再生されます。</div>
  </div>
</div>
<div id="playerContainer"></div>

<script>
const config = {
  videos: [
    { id: 'v1', url: 'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4', weight: 30 },
    { id: 'v2', url: 'https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.mp4', weight: 20 },
    { id: 'v3', url: 'https://raw.githubusercontent.com/yumemiru28000/yumemirusougenn/main/9.mp4', weight: 50 }
  ],
  bypassPassword: '0505',
  allowedTimes: [
    {hour:6, startMinute:0, endMinute:5},
    {hour:7, startMinute:0, endMinute:5}
  ]
};

function nowJST(){const d=new Date();return new Date(d.getTime()+(d.getTimezoneOffset()*60000)+9*3600*1000);}
function weightedPick(list){const total=list.reduce((s,i)=>s+(i.weight||1),0);let r=Math.random()*total;for(const item of list){r-= (item.weight||1); if(r<=0) return item;} return list[list.length-1];}

const joinBtn=document.getElementById('joinBtn');
const pwInput=document.getElementById('pw');
const remainingTimeDiv=document.getElementById('remainingTime');

function isWithinAllowedWindow(){const j=nowJST();for(const t of config.allowedTimes){const start=new Date(j);start.setHours(t.hour,t.startMinute,0,0);const end=new Date(j);end.setHours(t.hour,t.endMinute,59,999);if(j>=start && j<=end) return true;} return false;}
function getNextWindow(){const j=nowJST();let nextStart=null;for(const t of config.allowedTimes){const start=new Date(j);start.setHours(t.hour,t.startMinute,0,0);if(start>j && (!nextStart || start<nextStart)) nextStart=start;} if(!nextStart){const t=config.allowedTimes[0]; nextStart=new Date(j.getTime()+24*3600*1000);nextStart.setHours(t.hour,t.startMinute,0,0);} return nextStart;}

function updateButtonState(){
  const j=nowJST();
  const pw=pwInput.value===config.bypassPassword;
  const allowed=isWithinAllowedWindow() || pw;
  joinBtn.disabled=!allowed;
  joinBtn.textContent=pw?'ラジオ体操参加（パスワード解除）':allowed?'ラジオ体操参加':'時間外';

  if(!pw){
    if(allowed){
      let closestEnd=null;
      for(const t of config.allowedTimes){const end=new Date(j); end.setHours(t.hour,t.endMinute,59,999); if(end>j && (!closestEnd||end<closestEnd)) closestEnd=end;}
      if(closestEnd){const diff=closestEnd-j; const minutes=Math.floor(diff/60000); const seconds=Math.floor((diff%60000)/1000); remainingTimeDiv.textContent=`残り時間: ${minutes}分 ${seconds}秒`;}
      else remainingTimeDiv.textContent='時間外';
    }else{
      const nextStart=getNextWindow();
      const diff=nextStart-j;
      const hours=Math.floor(diff/3600000);
      const minutes=Math.floor((diff%3600000)/60000);
      const seconds=Math.floor((diff%60000)/1000);
      remainingTimeDiv.textContent=`次の参加可能時間まで: ${hours}時間 ${minutes}分 ${seconds}秒`;
    }
  }else remainingTimeDiv.textContent='';
}

// --- 動画再生関数 ---
async function onJoin(){
  if(localStorage.getItem('played')==='true'){
    alert('すでに再生済みです');
    return;
  }

  const pick=weightedPick(config.videos);
  if(!pick){alert('動画が登録されていません'); return;}
  const container=document.getElementById('playerContainer');
  container.style.display='flex'; container.innerHTML='';
  const vid=document.createElement('video');
  vid.src=pick.url; vid.playsInline=true; vid.autoplay=true; vid.controls=false; vid.loop=false;
  container.appendChild(vid);

  // 再生開始時にフラグをセット
  localStorage.setItem('played','true');

  // 動画読み込み後に再生・フルスクリーン
  vid.addEventListener('loadeddata', async ()=>{
    try{ await vid.play(); }catch(e){console.warn(e);}
    try{ if(container.requestFullscreen) await container.requestFullscreen({navigationUI:'hide'};}catch(e){console.warn(e);}
  });

  // 操作制限
  const blockKeys=(ev)=>{const blocked=[' ','Spacebar','k','K','MediaPlayPause','MediaStop','Escape']; if(blocked.includes(ev.key)||blocked.includes(ev.code)){ev.preventDefault();}};
  document.addEventListener('keydown',blockKeys,{capture:true});
  const preventAction=(ev)=>{ev.preventDefault(); ev.stopPropagation();};
  container.addEventListener('contextmenu',preventAction);
  container.addEventListener('click',preventAction);

  // --- 動画終了時に「END」表示 ---
  vid.addEventListener('ended', ()=>{
    container.innerHTML='END';
    container.style.display='flex';
    container.style.fontSize='64px';
    container.style.color='#fff';
    container.style.justifyContent='center';
    container.style.alignItems='center';
  });
}

init=()=>{updateButtonState(); setInterval(updateButtonState,1000); pwInput.addEventListener('input',updateButtonState); joinBtn.addEventListener('click',onJoin);};
init();
</script>
</body>
</html>
